{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    Rezerwacje
{% endblock %}

{% block container %}

    <form action="" method="post">
        {% csrf_token %}

        {{ form|crispy }}
        {{ form.errors }}
        <button type="submit" class="btn btn-success">Wykonaj</button>
    </form>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');


        let club_field = document.getElementById("id_club")
        let coach_field = document.getElementById("id_coach")
        let court_field = document.getElementById("id_court")
        club_field.addEventListener("change", getClubId)


        function getClubId(e) {
            console.log(e.target.value)
            let club_id = e.target.value


            const data = {id: club_id};

            let url = "{% url 'reservation:get_coach' %}"
            let url2 = "{% url 'reservation:get_court' %}"


            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                console.log('Success:', data);
                coach_field.innerHTML = '<option value="" selected>------</option>'
                for(let i=0; i < data.length; i++){
                    coach_field.innerHTML += `<option value=" ${data[i]["id"]}" selected"">${data[i]["name"]}</option>`
                }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });


            fetch(url2, {
                method: 'POST', // or 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                console.log('Success:', data);
                court_field.innerHTML = '<option value="" selected>------</option>'
                for(let i=0; i < data.length; i++){
                    court_field.innerHTML += `<option value=" ${data[i]["id"]}" selected"">${data[i]["name"]}</option>`
                }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

    </script>

{% endblock %}